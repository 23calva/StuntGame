using UnityEngine;

namespace StuntGame
{
    public class Wheel : MonoBehaviour
    {
        public Vehicle vehicle;
        private Spring spring;

        private float radius = 0.25f;

        private void Start()
        {
            vehicle = transform.parent.GetComponent<Vehicle>();
            spring = vehicle.spring;
        }

        private void FixedUpdate()
        {
            //spring = vehicle.spring; // Debug, maybe editor only?

            if(Physics.Raycast(new Ray(transform.position, -vehicle.transform.up), out RaycastHit hit, spring.maxRange + radius))
            {
                float prevLength = spring.length;

                spring.length = hit.distance - radius;
                spring.length = Mathf.Clamp(spring.length, spring.minRange, spring.maxRange);

                float velocity = (prevLength - spring.length) / Time.fixedDeltaTime;
                float force = spring.stiffness * (spring.restLength - spring.length) + spring.damping * velocity;

                vehicle.body.AddForceAtPosition(force * vehicle.transform.up, hit.point);
            }
        }

        private void OnDrawGizmos()
        {
            Gizmos.color = Color.cyan;
            if(vehicle != null)
            {
                Gizmos.DrawRay(transform.position, -vehicle.transform.up * (spring.maxRange + radius));
            }
        }
    }
}